<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dent 자동분석 시스템</title>
    <!-- DatePicker 및 스타일 시트 -->
    <link rel="stylesheet" href="../static/vendor/jquery-ui-datepicker/jquery-ui.min.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <script src="../static/vendor/jquery-3.7.1.min.js"></script>
    <script src="../static/vendor/jquery-ui-datepicker/jquery-ui.min.js"></script>
</head>
<body>
<div id="wrap">
    <!-- Sidebar -->
    <div id="sideMenu">
        <div class="fixed-section">
            <!-- 로고 -->
            <h1 class="logo"><img src="../static/images/logo.svg" alt="Audi"></h1>
            <!-- 날짜 선택기 -->
            <div class="datepicker-section">
                <h2 class="title">일자별 차량</h2>
                <div id="datepickerDent"></div>
            </div>
            <!-- 검색 섹션 -->
            <div class="search-section">
                <p>2024년 10월 21일 총 분석 차량 수</p>
                <!-- 분석 차량 수를 표시하는 요소 -->
                <strong class="total-num">0</strong>
                <div class="search-box">
                    <!-- 차량 번호 검색 입력 -->
                    <input type="text" placeholder="차량번호 검색" class="search-input" onchange="filterReports()">
                </div>
            </div>
        </div>
        <!-- 검색 결과 리스트 -->
        <div class="result-section">
            <ul id="resultAccordion" class="result-list"></ul>
        </div>
    </div>

    <!-- Main Content -->
    <main id="content">
        <div class="__inner">
            <!-- 상단 버튼 -->
            <ul class="top-handle-menu">
<!--                <li>-->
<!--                    &lt;!&ndash; 결과 다운로드 버튼 &ndash;&gt;-->
<!--                    <button id="downloadResult" class="btn icon download" title="파일 저장"></button>-->
<!--                </li>-->
                <li>
                    <!-- 결과 인쇄 버튼 -->
                    <button id="printResult" class="btn icon print" title="인쇄"></button>
                </li>
            </ul>
            <!-- 메인 패널 -->
            <div class="main-pannel">
                <h3 class="pannel-title">차량 덴트 분석 결과</h3>
                <div class="pannel-content">
                    <!-- 차량 요약 정보 -->
                    <ul class="summary-list">
                        <li class="summary-item">
                            <dl>
                                <dt>차량 번호</dt>
                                <dd></dd>
                            </dl>
                        </li>
                        <li class="summary-item">
                            <dl>
                                <dt>입차 일시</dt>
                                <dd></dd>
                            </dl>
                        </li>
                        <li class="summary-item">
                            <dl>
                                <dt>분석 일시</dt>
                                <dd></dd>
                            </dl>
                        </li>
                    </ul>
                    <!-- 덴트 분석 수량 -->
                    <div class="dent-total">
                        <h4 class="title">전체 덴트 수량</h4>
                        <table class="table">
                            <colgroup>
                                <col width="25%">
                                <col width="25%">
                                <col width="25%">
                                <col width="25%">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th>구분</th>
                                <td>덴트</td>
                                <td>스크래치</td>
                                <td>데미지</td>
                            </tr>
                            <tr>
                                <th>수량</th>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- 각 위치별 덴트 테이블 -->
                    <article class="vehicle-wrap">
                        <div class="__vehicle-bg"></div>
                        <!-- A 좌측 -->
                        <div class="dent-table-box A">
                            <h4 class="title">A 좌측</h4>
                            <table class="table">
                                <tbody>
                                <tr>
                                    <th>구분</th>
                                    <th>수량</th>
                                </tr>
                                <tr>
                                    <td>덴트</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>스크래치</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>데미지</td>
                                    <td></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- B 본넷 -->
                        <div class="dent-table-box B">
                            <h4 class="title">B 본넷</h4>
                            <table class="table">
                                <tbody>
                                <tr>
                                    <th>구분</th>
                                    <th>수량</th>
                                </tr>
                                <tr>
                                    <td>덴트</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>스크래치</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>데미지</td>
                                    <td></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- C 우측 -->
                        <div class="dent-table-box C">
                            <h4 class="title">C 우측</h4>
                            <table class="table">
                                <tbody>
                                <tr>
                                    <th>구분</th>
                                    <th>수량</th>
                                </tr>
                                <tr>
                                    <td>덴트</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>스크래치</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>데미지</td>
                                    <td></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- D 트렁크 -->
                        <div class="dent-table-box D">
                            <h4 class="title">D 트렁크(테일 게이트)</h4>
                            <table class="table">
                                <tbody>
                                <tr>
                                    <th>구분</th>
                                    <th>수량</th>
                                </tr>
                                <tr>
                                    <td>덴트</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>스크래치</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>데미지</td>
                                    <td></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </article>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Popup -->
<div id="vehicleVideoPop" class="popup-wrap">
    <div class="popup-container">
        <div class="popup-content">
            <div class="popup-head">
                <p class="title-text">데이터가 없습니다.</p>
                <button type="button" class="btn icon btn-close" title="닫기"></button>
            </div>
            <div class="popup-body">
                <video class="vehicle-video" controls src="../static/video/test.webm" type="video/webm">
                    동영상을 지원하지 않는 브라우저입니다.
                </video>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import Accordion from '../static/js/Accordion.js';
    import Popup from '../static/js/Popup.js';

    let currentReportId = null;

    // 초기화
    function initialize() {
        setupDatePicker(); // DatePicker 초기화
        setupEventListeners(); // 이벤트 리스너 등록
    }

    // DatePicker 설정
    function setupDatePicker() {
        $("#datepickerDent").datepicker({
            dateFormat: 'yy-mm-dd',
            showMonthAfterYear: true,
            monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
            changeMonth: true,
            changeYear: true,
            onSelect: filterReports // 날짜 선택 시 필터링
        });
        addYearSuffix(); // '년' 텍스트 추가
    }

    // '년' 텍스트 추가
    function addYearSuffix() {
        $(".ui-datepicker-year option").each(function () {
            const yearText = $(this).val();
            $(this).text(yearText + "년");
        });
    }

    // 이벤트 리스너 설정
    function setupEventListeners() {
        document.querySelector("#resultAccordion").addEventListener("click", handleAccordionClick);
        document.querySelector("#printResult").addEventListener("click", printReport);
    }

    // 아코디언 클릭 처리
    function handleAccordionClick(event) {
        const target = event.target;

        // 차량 헤드 클릭 시
        const clickedVehicle = target.closest(".accord-head");
        if (clickedVehicle) {
            // 모든 아코디언 헤드에서 isDent 클래스 제거
            const allVehicles = document.querySelectorAll(".accord-head");
            allVehicles.forEach(vehicle => vehicle.classList.remove("isDent"));

            // 현재 클릭된 아코디언 헤드에 isDent 클래스 추가
            clickedVehicle.classList.add("isDent");

            // 차량 ID 가져오기 및 로드
            const vehicleId = clickedVehicle.parentElement.querySelector(".parts-list").dataset.id;
            console.log("Vehicle clicked - Loading report for ID:", vehicleId);
            loadReport(vehicleId);

            return;
        }

        // 부품 리스트 클릭 시
        const clickedPart = target.closest("li");
        if (clickedPart) {
            // 기존 isDent 클래스 제거
            const partsList = clickedPart.parentElement.querySelectorAll("li");
            partsList.forEach(part => part.classList.remove("isDent"));

            // 현재 클릭된 항목에 isDent 클래스 추가
            clickedPart.classList.add("isDent");

            // `data-file-name` 속성 읽기
            const fileName = clickedPart.parentElement.dataset.fileName;
            console.log("Part clicked:", clickedPart.dataset);

            showPopUp(clickedPart.dataset, fileName); // 팝업 표시

            return;
        }
    }

    // 보고서 필터링
    function filterReports() {
        const date = $("#datepickerDent").datepicker("getDate");
        const searchInput = $(".search-input").val().trim();
        if (!date) return alert("유효하지 않은 날짜입니다.");

        const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")}`;

        fetch(`/filter_reports?date=${formattedDate}&car_number=${searchInput}`)
            .then((response) => response.json())
            .then(updateAccordion) // 아코디언 업데이트
            .catch(console.error);
    }

    // 아코디언 업데이트
    function updateAccordion(data) {
        const accordion = document.querySelector("#resultAccordion");
        accordion.innerHTML = "";

        // total-num 업데이트
        const totalNumElement = document.querySelector(".total-num");

        // 데이터가 없을 경우 처리
        if (!data.length) {
            accordion.innerHTML = '<li class="no-results">검색 결과가 없습니다.</li>';
            totalNumElement.textContent = "0";
            return;
        }

        totalNumElement.textContent = data.length;

        data.forEach(vehicle => {
            const listItem = document.createElement("li");
            listItem.className = "result-item accord-item";
            listItem.innerHTML = `
                <div class="accord-head">
                    <svg class="icon" width="20" height="20" viewBox="0 0 20 20" fill="#1D1D1E" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M14 10.4865L6 16V4L14 10.4865Z"/>
                    </svg>
                    <span class="text">${vehicle.car_number}</span>
                </div>
                <div class="accord-body">
                    <ul class="parts-list" data-id="${vehicle.id}" data-file-name="${vehicle.file_name}">
                        <li data-date="${vehicle.data_time.slice(0, -4)}" data-number="${vehicle.car_number}" data-part="우측 하단">우측 하단 (camera01)</li>
                        <li data-date="${vehicle.data_time.slice(0, -4)}" data-number="${vehicle.car_number}" data-part="우측 중간">우측 중간 (camera02)</li>
                        <li data-date="${vehicle.data_time.slice(0, -4)}" data-number="${vehicle.car_number}" data-part="우측 상단">우측 상단 (camera03)</li>
                        <li data-date="${vehicle.data_time.slice(0, -4)}" data-number="${vehicle.car_number}" data-part="좌측 하단">좌측 하단 (camera04)</li>
                        <li data-date="${vehicle.data_time.slice(0, -4)}" data-number="${vehicle.car_number}" data-part="좌측 중간">좌측 중간 (camera05)</li>
                        <li data-date="${vehicle.data_time.slice(0, -4)}" data-number="${vehicle.car_number}" data-part="좌측 상단">좌측 상단 (camera06)</li>
                    </ul>
                </div>`;
            accordion.appendChild(listItem);
        });

        new Accordion("#resultAccordion");
    }

    // 보고서 로드
    function loadReport(reportId) {
        fetch(`/report/${reportId}`)
            .then((response) => response.json())
            .then(updateMainPanel) // 메인 패널 업데이트
            .catch(console.error);
    }

    // 메인 패널 업데이트
    function updateMainPanel(data) {
        currentReportId = data.id;

        document.querySelector(".pannel-content").innerHTML = `
            <ul class="summary-list">
                <li><dl><dt>차량 번호</dt><dd>${data.car_number}</dd></dl></li>
                <li><dl><dt>입차 일시</dt><dd>${formatDateTime(data.data_time)}</dd></dl></li>
                <li><dl><dt>분석 일시</dt><dd>${formatDateTime(data.analyze_time)}</dd></dl></li>
            </ul>
            <div class="dent-total">
                <h4 class="title">전체 덴트 수량</h4>
                <table class="table">
                    <tr><th>구분</th><td>덴트</td><td>스크래치</td><td>데미지</td></tr>
                    <tr><th>수량</th><td>${data.total_dents}</td><td>${data.total_scratch}</td><td>${data.total_damage}</td></tr>
                </table>
            </div>
            <article class="vehicle-wrap">
                <div class="__vehicle-bg"></div>
                ${generateDentTable('A', 'A 좌측', data.left_dent_total, data.left_scratch, data.left_damage)}
                ${generateDentTable('B', 'B 본넷', data.front_dent_total, data.front_scratch, data.front_damage)}
                ${generateDentTable('C', 'C 우측', data.right_dent_total, data.right_scratch, data.right_damage)}
                ${generateDentTable('D', 'D 트렁크(테일 게이트)', data.tail_dent_total, data.tail_scratch, data.tail_damage)}
            </article>`;
    }

    // 날짜 및 시간 포맷
    function formatDateTime(dateTime) {
        const date = new Date(dateTime);
        return `${date.getFullYear()}.${(date.getMonth() + 1).toString().padStart(2, "0")}.${date.getDate().toString().padStart(2, "0")} / ${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}:${date.getSeconds().toString().padStart(2, "0")}`;
    }

    // 선택된 보고서 출력
    function printReport() {
        const $printBtn = document.querySelector('#printResult');
        $printBtn.addEventListener('click', () => {
            print();
        })
    }

    // 덴트 테이블 생성 함수
    function generateDentTable(section, sectionName, dent, scratch, damage) {
        return `
    <div class="dent-table-box ${section}">
        <h4 class="title">${sectionName}</h4>
        <table class="table">
            <tbody>
                <tr>
                    <th>구분</th>
                    <th>수량</th>
                </tr>
                <tr>
                    <td>덴트</td>
                    <td>${dent || 0}</td>
                </tr>
                 <tr>
                    <td>스크래치</td>
                    <td>${scratch || 0}</td>
                </tr>
                <tr>
                    <td>데미지</td>
                    <td>${damage || 0}</td>
                </tr>
            </tbody>
        </table>
    </div>`;
    }

    //팝업 표시
    function showPopUp(clickedPart, fileName) {

        if (fileName) {
            // 비디오 태그의 src 업데이트
            const popupContent = document.querySelector("#vehicleVideoPop .title-text");
            popupContent.innerHTML = `<span class="date">${clickedPart.date}</span><span class="number">${clickedPart.number}</span><span class="part">${clickedPart.part}</span>`;
            const videoElement = document.querySelector(".vehicle-video");

            // videoElement.src = `../static/video/${fileName}`; // 비디오 경로 설정
            videoElement.src = `../static/video/test.webm`; // 비디오 경로 설정

            // 팝업 열기
            const popup = new Popup("#vehicleVideoPop");
            popup.open();
        } else {
            console.error("파일 이름이 없습니다.");
        }

    }


    // 초기화 실행
    initialize();
</script>
</body>
</html>